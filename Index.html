<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autentica√ß√£o BCH.games</title>
</head>
<body>
    <h2>Autentica√ß√£o BCH.games</h2>
    <label for="token">Auth Token:</label>
    <input type="text" id="token" placeholder="Cole seu auth_token_v1 aqui">
    <button onclick="autenticar()">Login</button>
    <p id="status">‚è≥ Aguardando autentica√ß√£o...</p>

    <h3>Queries</h3>
    <button onclick="consultarJogos()">Obter Jogos Ativos (Mines)</button>
    <pre id="resultado"></pre>

    <h3>Cashout</h3>
    <label for="cashoutId">ID da Aposta (Cashout):</label>
    <input type="text" id="cashoutId" placeholder="Cole o _id da aposta aqui">
    <button onclick="realizarCashout()">Fazer Cashout</button>
    <pre id="cashoutResultado"></pre>

    <script>
        let ws;
        let isConnected = false;

        function autenticar() {
            const token = document.getElementById("token").value;
            if (!token) {
                alert("Por favor, insira seu auth_token_v1!");
                return;
            }

            ws = new WebSocket("wss://bch.games/api/graphql", "graphql-transport-ws");

            ws.onopen = () => {
                document.getElementById("status").textContent = "‚úÖ Conectado! Iniciando autentica√ß√£o...";
                
                ws.send(JSON.stringify({ type: "connection_init", payload: {} }));

                setTimeout(() => {
                    let authPayload = {
                        id: "1",
                        type: "subscribe",
                        payload: {
                            query: `{
                                authenticate(authToken: "${token}") {
                                    _id
                                    username
                                    email
                                }
                            }`,
                            variables: {}
                        }
                    };

                    ws.send(JSON.stringify(authPayload));
                }, 1000);
            };

            ws.onmessage = (event) => {
                let data = JSON.parse(event.data);
                console.log("üì© Mensagem recebida:", data);

                if (data.type === "next" && data.payload?.data?.authenticate) {
                    let user = data.payload.data.authenticate;
                    document.getElementById("status").textContent = `‚úÖ Logado como ${user.username} (${user.email})`;
                    isConnected = true;
                } else if (data.type === "error") {
                    document.getElementById("status").textContent = "‚ùå Erro na autentica√ß√£o!";
                } else if (data.type === "next" && data.payload?.data?.minesGetActiveGames) {
                    document.getElementById("resultado").textContent = JSON.stringify(data.payload.data.minesGetActiveGames, null, 2);
                } else if (data.type === "next" && data.payload?.data?.minesCashout) {
                    document.getElementById("cashoutResultado").textContent = JSON.stringify(data.payload.data.minesCashout, null, 2);
                }
            };

            ws.onerror = (err) => {
                console.error("Erro no WebSocket:", err);
                document.getElementById("status").textContent = "‚ùå Erro de conex√£o!";
            };

            ws.onclose = () => {
                document.getElementById("status").textContent = "üî¥ WebSocket desconectado!";
                isConnected = false;
            };
        }

        function consultarJogos() {
            if (!isConnected || !ws || ws.readyState !== WebSocket.OPEN) {
                alert("Voc√™ precisa estar autenticado para consultar os jogos!");
                return;
            }

            let queryPayload = {
                id: crypto.randomUUID(),
                type: "subscribe",
                payload: {
                    query: `{
                        minesGetActiveGames {
                            _id
                            amount
                            details {
                                ... on MinesGameDetails {
                                    __typename
                                    mines
                                    uncovered
                                    minesCount
                                }
                                __typename
                            }
                        }
                    }`,
                    variables: {}
                }
            };

            ws.send(JSON.stringify(queryPayload));
        }

        function realizarCashout() {
            const apostaId = document.getElementById("cashoutId").value;
            if (!apostaId) {
                alert("Por favor, insira o _id da aposta!");
                return;
            }

            if (!isConnected || !ws || ws.readyState !== WebSocket.OPEN) {
                alert("Voc√™ precisa estar autenticado para realizar o cashout!");
                return;
            }

            let cashoutPayload = {
                id: crypto.randomUUID(),
                type: "subscribe",
                payload: {
                    query: `mutation ($_id: ID!) {
                        minesCashout(_id: $_id) {
                            id
                            isWin
                            multiplier
                            profit
                            amount
                            details {
                                ... on MinesGameDetails {
                                    __typename
                                    mines
                                    uncovered
                                    minesCount
                                }
                                __typename
                            }
                        }
                    }`,
                    variables: {
                        _id: apostaId
                    }
                }
            };

            ws.send(JSON.stringify(cashoutPayload));
        }
    </script>
</body>
</html>
